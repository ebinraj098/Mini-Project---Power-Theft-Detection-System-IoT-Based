#include <Wire.h>
#include <LiquidCrystal_I2C.h>

LiquidCrystal_I2C lcd(0x27, 16, 2);
#define RELAY 7

#define SAMPLES 200
#define SENSOR1 A0
#define SENSOR2 A1

float sensitivity = 0.185; // for ACS712 5A version (V/A)
float offset = 2.5;        // midpoint ~2.5V

float readCurrent(int pin) {
  long sum = 0;
  for (int i = 0; i < SAMPLES; i++) {
    int val = analogRead(pin);
    float voltage = (val * 5.0) / 1024.0;
    float current = (voltage - offset) / sensitivity;
    sum += sq(current);
    delayMicroseconds(1000);
  }
  return sqrt(sum / SAMPLES);
}

void setup() {
  pinMode(RELAY, OUTPUT);
  digitalWrite(RELAY, LOW);
  Serial.begin(9600);
  lcd.init();
  lcd.backlight();
  lcd.setCursor(0,0);
  lcd.print("Power Theft");
  lcd.setCursor(0,1);
  lcd.print(" Detection ");
  delay(2000);
}

void loop() {
  float iMain = readCurrent(SENSOR1);
  float iLoad = readCurrent(SENSOR2);

  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("Main:");
  lcd.print(iMain,1);
  lcd.print("A");

  lcd.setCursor(0,1);
  lcd.print("Load:");
  lcd.print(iLoad,1);
  lcd.print("A");

  if (iLoad > (iMain + 0.2)) { // tolerance of 0.2A
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("THEFT ALERT!");
    digitalWrite(RELAY, HIGH); // cut off load
    Serial.println("THEFT DETECTED"); // send to NodeMCU
  } else {
    digitalWrite(RELAY, LOW);
    Serial.println("NORMAL");
  }

  delay(1000);
}
